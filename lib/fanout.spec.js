'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var fanout = require('./fanout');

describe('fanout', function () {

  describe('createStreams', function () {

    it('creates a direct connection between input stream and src ', function (done) {
      var input = stream.Readable({ objectMode: true, highWaterMark: 2, read: sinon.stub() });
      var created = fanout.createStreams();
      var ext = created.ext;
      var src = created.src;

      sinon.stub(src, 'push', src.push);
      sinon.stub(ext, 'write', ext.write);

      input.pipe(ext);

      var i = 0;
      var pushResults = [];
      while (++i <= 3) {
        pushResults.push(input.push(i));
      }expect(pushResults).to.deep.equal([true, false, false]);
      expect(src.push.callCount).to.equal(0);
      expect(ext.write.callCount).to.equal(0);
      expect(input._read.callCount).to.equal(0);

      setTimeout(function () {

        // Note: this shows that these are all asyncrhonous:
        expect(src.push.callCount).to.equal(3);
        expect(ext.write.callCount).to.equal(3);
        expect(input._read.callCount).to.equal(1);
        var j = 0;
        var readResults = [];
        while (++j <= 3) {
          readResults.push(src.read());
        }expect(readResults).to.deep.equal([1, 2, 3]);
        done();
      });
    });

    it('src will cause more read calls from the input', function (done) {

      // --------------------------------------------
      // this mess simulates our kafka consumer stream
      // ---------------------------------------------

      var consumer = new EventEmitter();
      var paused = true;
      var i = 0;

      function emit(consumer) {
        if (paused) return;
        consumer.emit('data', ++i);
        setTimeout(function () {
          emit(consumer);
        }, 100);
      }

      consumer.on('resume', function () {
        paused = false;
        emit(consumer);
      });

      consumer.on('pause', function () {
        paused = true;
      });

      function reader() {
        consumer.emit('resume');
      }

      var input = stream.Readable({ objectMode: true, highWaterMark: 2, read: reader });

      consumer.on('data', function (data) {
        if (!input.push(data)) {
          consumer.emit('pause');
        }
      });

      // ------------------------------------------------
      // end mess
      // ------------------------------------------------

      var created = fanout.createStreams();
      var ext = created.ext;
      var src = created.src;

      src._readableState.highWaterMark = 2;
      ext._writableState.highWaterMark = 3;

      sinon.stub(src, 'push', src.push);
      sinon.stub(ext, 'write', ext.write);
      sinon.stub(input, 'push', input.push);

      input.on('readable', _.noop); // kick off

      input.pipe(ext);

      // nothing should happen syncrhonously
      expect(src.push.callCount).to.equal(0);

      setTimeout(function () {

        // Here we see the effects of buffering that builds up
        // before the emitter is stopped.
        expect(input.push.callCount).to.equal(6);
        expect(ext.write.callCount).to.equal(4);
        expect(src.push.callCount).to.equal(2);

        // read 6 times
        var firstReads = [];
        var i = 0;
        while (++i <= 6) {
          firstReads.push(src.read());
        }expect(firstReads).to.deep.equal([1, 2, 3, 4, 5, 6]);

        // reading 6 times should have called the input.push
        // function 6 more times, and filled up all the other
        // buffers along the way.
        expect(input.push.callCount).to.equal(12);
        expect(ext.write.callCount).to.equal(10);
        expect(src.push.callCount).to.equal(8);

        done();
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QUFMLEVBQU8sQ0FBUCxFQUFTLENBQVQsRUFBVyxDQUFYLENBQWpDOzs7OztBQVplLGNBaUJmLENBQU8sTUFBTSxJQUFOLENBQVcsU0FBWCxDQUFQLENBQTZCLEVBQTdCLENBQWdDLEtBQWhDLENBQXNDLEVBQXRDLEVBakJlO0FBa0JmLGVBQU8sSUFBSSxLQUFKLENBQVUsU0FBVixDQUFQLENBQTRCLEVBQTVCLENBQStCLEtBQS9CLENBQXFDLEVBQXJDLEVBbEJlO0FBbUJmLGVBQU8sSUFBSSxJQUFKLENBQVMsU0FBVCxDQUFQLENBQTJCLEVBQTNCLENBQThCLEtBQTlCLENBQW9DLENBQXBDLEVBbkJlOztBQXFCZixlQXJCZTtPQUFOLENBQVgsQ0E5RDBEO0tBQVIsQ0FBcEQsQ0FyQzhCO0dBQU4sQ0FBMUIsQ0FGdUI7Q0FBTixDQUFuQiIsImZpbGUiOiJmYW5vdXQuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY2hhaS51c2UocmVxdWlyZSgnc2lub24tY2hhaScpKTtcbnZhciBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbnZhciBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xudmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbnZhciBmYW5vdXQgPSByZXF1aXJlKCcuL2Zhbm91dCcpXG5cblxuZGVzY3JpYmUoJ2Zhbm91dCcsICgpID0+IHtcblxuICBkZXNjcmliZSgnY3JlYXRlU3RyZWFtcycsICgpID0+IHtcblxuICAgIGl0KCdjcmVhdGVzIGEgZGlyZWN0IGNvbm5lY3Rpb24gYmV0d2VlbiBpbnB1dCBzdHJlYW0gYW5kIHNyYyAnLCBkb25lID0+IHtcbiAgICAgIHZhciBpbnB1dCA9IHN0cmVhbS5SZWFkYWJsZSh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDIsIHJlYWQ6IHNpbm9uLnN0dWIoKSB9KTtcbiAgICAgIHZhciBjcmVhdGVkID0gZmFub3V0LmNyZWF0ZVN0cmVhbXMoKTtcbiAgICAgIHZhciBleHQgPSBjcmVhdGVkLmV4dDtcbiAgICAgIHZhciBzcmMgPSBjcmVhdGVkLnNyYztcblxuICAgICAgc2lub24uc3R1YihzcmMsICdwdXNoJywgc3JjLnB1c2gpO1xuICAgICAgc2lub24uc3R1YihleHQsICd3cml0ZScsIGV4dC53cml0ZSk7XG5cbiAgICAgIGlucHV0LnBpcGUoZXh0KTtcblxuICAgICAgdmFyIGkgPSAwO1xuICAgICAgdmFyIHB1c2hSZXN1bHRzID0gW11cbiAgICAgIHdoaWxlICgrK2kgPD0gMykgcHVzaFJlc3VsdHMucHVzaChpbnB1dC5wdXNoKGkpKTtcblxuICAgICAgZXhwZWN0KHB1c2hSZXN1bHRzKS50by5kZWVwLmVxdWFsKFt0cnVlLCBmYWxzZSwgZmFsc2VdKTtcbiAgICAgIGV4cGVjdChzcmMucHVzaC5jYWxsQ291bnQpLnRvLmVxdWFsKDApO1xuICAgICAgZXhwZWN0KGV4dC53cml0ZS5jYWxsQ291bnQpLnRvLmVxdWFsKDApO1xuICAgICAgZXhwZWN0KGlucHV0Ll9yZWFkLmNhbGxDb3VudCkudG8uZXF1YWwoMClcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICAgICAgLy8gTm90ZTogdGhpcyBzaG93cyB0aGF0IHRoZXNlIGFyZSBhbGwgYXN5bmNyaG9ub3VzOlxuICAgICAgICBleHBlY3Qoc3JjLnB1c2guY2FsbENvdW50KS50by5lcXVhbCgzKTtcbiAgICAgICAgZXhwZWN0KGV4dC53cml0ZS5jYWxsQ291bnQpLnRvLmVxdWFsKDMpO1xuICAgICAgICBleHBlY3QoaW5wdXQuX3JlYWQuY2FsbENvdW50KS50by5lcXVhbCgxKVxuICAgICAgICB2YXIgaiA9IDA7XG4gICAgICAgIHZhciByZWFkUmVzdWx0cyA9IFtdO1xuICAgICAgICB3aGlsZSgrK2ogPD0gMykgcmVhZFJlc3VsdHMucHVzaChzcmMucmVhZCgpKTtcblxuICAgICAgICBleHBlY3QocmVhZFJlc3VsdHMpLnRvLmRlZXAuZXF1YWwoWzEsMiwzXSk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pXG4gICAgfSk7XG5cbiAgICBpdCgnc3JjIHdpbGwgY2F1c2UgbW9yZSByZWFkIGNhbGxzIGZyb20gdGhlIGlucHV0JywgZG9uZSA9PiB7XG5cbiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAvLyB0aGlzIG1lc3Mgc2ltdWxhdGVzIG91ciBrYWZrYSBjb25zdW1lciBzdHJlYW1cbiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgICB2YXIgY29uc3VtZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICB2YXIgcGF1c2VkID0gdHJ1ZTtcbiAgICAgIHZhciBpID0gMDtcblxuICAgICAgZnVuY3Rpb24gZW1pdCAoY29uc3VtZXIpIHtcbiAgICAgICAgaWYgKHBhdXNlZCkgcmV0dXJuO1xuICAgICAgICBjb25zdW1lci5lbWl0KCdkYXRhJywgKytpKTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgZW1pdChjb25zdW1lcilcbiAgICAgICAgfSwgMTAwKVxuICAgICAgfVxuXG4gICAgICBjb25zdW1lci5vbigncmVzdW1lJywgKCkgPT4ge1xuICAgICAgICBwYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgZW1pdChjb25zdW1lcik7XG4gICAgICB9KVxuXG4gICAgICBjb25zdW1lci5vbigncGF1c2UnLCAoKSA9PiB7XG4gICAgICAgIHBhdXNlZCA9IHRydWU7XG4gICAgICB9KVxuXG4gICAgICBmdW5jdGlvbiByZWFkZXIgKCkge1xuICAgICAgICBjb25zdW1lci5lbWl0KCdyZXN1bWUnKTtcbiAgICAgIH1cblxuICAgICAgdmFyIGlucHV0ID0gc3RyZWFtLlJlYWRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSwgaGlnaFdhdGVyTWFyazogMiwgcmVhZDogcmVhZGVyIH0pO1xuXG4gICAgICBjb25zdW1lci5vbignZGF0YScsIGRhdGEgPT4ge1xuICAgICAgICBpZiAoIWlucHV0LnB1c2goZGF0YSkpIHtcbiAgICAgICAgICBjb25zdW1lci5lbWl0KCdwYXVzZScpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAvLyBlbmQgbWVzc1xuICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICAgIHZhciBjcmVhdGVkID0gZmFub3V0LmNyZWF0ZVN0cmVhbXMoKTtcbiAgICAgIHZhciBleHQgPSBjcmVhdGVkLmV4dDtcbiAgICAgIHZhciBzcmMgPSBjcmVhdGVkLnNyYztcblxuICAgICAgc3JjLl9yZWFkYWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsgPSAyO1xuICAgICAgZXh0Ll93cml0YWJsZVN0YXRlLmhpZ2hXYXRlck1hcmsgPSAzO1xuXG4gICAgICBzaW5vbi5zdHViKHNyYywgJ3B1c2gnLCBzcmMucHVzaCk7XG4gICAgICBzaW5vbi5zdHViKGV4dCwgJ3dyaXRlJywgZXh0LndyaXRlKTtcbiAgICAgIHNpbm9uLnN0dWIoaW5wdXQsICdwdXNoJywgaW5wdXQucHVzaCk7XG5cbiAgICAgIGlucHV0Lm9uKCdyZWFkYWJsZScsIF8ubm9vcCk7IC8vIGtpY2sgb2ZmXG5cbiAgICAgIGlucHV0XG4gICAgICAgIC5waXBlKGV4dCk7XG5cbiAgICAgIC8vIG5vdGhpbmcgc2hvdWxkIGhhcHBlbiBzeW5jcmhvbm91c2x5XG4gICAgICBleHBlY3Qoc3JjLnB1c2guY2FsbENvdW50KS50by5lcXVhbCgwKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICAgICAgLy8gSGVyZSB3ZSBzZWUgdGhlIGVmZmVjdHMgb2YgYnVmZmVyaW5nIHRoYXQgYnVpbGRzIHVwXG4gICAgICAgIC8vIGJlZm9yZSB0aGUgZW1pdHRlciBpcyBzdG9wcGVkLlxuICAgICAgICBleHBlY3QoaW5wdXQucHVzaC5jYWxsQ291bnQpLnRvLmVxdWFsKDYpO1xuICAgICAgICBleHBlY3QoZXh0LndyaXRlLmNhbGxDb3VudCkudG8uZXF1YWwoNCk7XG4gICAgICAgIGV4cGVjdChzcmMucHVzaC5jYWxsQ291bnQpLnRvLmVxdWFsKDIpO1xuXG4gICAgICAgIC8vIHJlYWQgNiB0aW1lc1xuICAgICAgICB2YXIgZmlyc3RSZWFkcyA9IFtdO1xuICAgICAgICB2YXIgaSA9IDA7XG4gICAgICAgIHdoaWxlICgrK2kgPD0gNikgZmlyc3RSZWFkcy5wdXNoKHNyYy5yZWFkKCkpO1xuICAgICAgICBleHBlY3QoZmlyc3RSZWFkcykudG8uZGVlcC5lcXVhbChbMSwyLDMsNCw1LDZdKTtcblxuICAgICAgICAvLyByZWFkaW5nIDYgdGltZXMgc2hvdWxkIGhhdmUgY2FsbGVkIHRoZSBpbnB1dC5wdXNoXG4gICAgICAgIC8vIGZ1bmN0aW9uIDYgbW9yZSB0aW1lcywgYW5kIGZpbGxlZCB1cCBhbGwgdGhlIG90aGVyXG4gICAgICAgIC8vIGJ1ZmZlcnMgYWxvbmcgdGhlIHdheS5cbiAgICAgICAgZXhwZWN0KGlucHV0LnB1c2guY2FsbENvdW50KS50by5lcXVhbCgxMik7XG4gICAgICAgIGV4cGVjdChleHQud3JpdGUuY2FsbENvdW50KS50by5lcXVhbCgxMCk7XG4gICAgICAgIGV4cGVjdChzcmMucHVzaC5jYWxsQ291bnQpLnRvLmVxdWFsKDgpO1xuXG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcbn0pO1xuIl19