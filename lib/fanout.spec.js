'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var expect = chai.expect;
var sinon = require('sinon');
var _ = require('lodash');
var stream = require('stream');
var EventEmitter = require('events').EventEmitter;
var fanout = require('./fanout');

describe('fanout', function () {

  describe('createStreams', function () {

    it('propogates errors with the propogate flag', function (done) {
      var input = stream.Readable({ objectMode: true, read: sinon.stub() });
      input.pipe(fanout.createStreams({ propagate: true }, function () {
        return null;
      })).on('error', function (err) {
        expect(err).to.be.an.error;
        done();
      });
      input.emit('error', new Error('foo'));
    });

    it('creates a direct connection between input stream and src ', function (done) {
      var input = stream.Readable({ objectMode: true, highWaterMark: 2, read: sinon.stub() });
      var created = fanout.createStreams();
      var ext = created.ext;
      var src = created.src;

      sinon.stub(src, 'push', src.push);
      sinon.stub(ext, 'write', ext.write);

      input.pipe(ext);

      var i = 0;
      var pushResults = [];
      while (++i <= 3) {
        pushResults.push(input.push(i));
      }expect(pushResults).to.deep.equal([true, false, false]);
      expect(src.push.callCount).to.equal(0);
      expect(ext.write.callCount).to.equal(0);
      expect(input._read.callCount).to.equal(0);

      setTimeout(function () {

        // Note: this shows that these are all asyncrhonous:
        expect(src.push.callCount).to.equal(3);
        expect(ext.write.callCount).to.equal(3);
        expect(input._read.callCount).to.equal(1);
        var j = 0;
        var readResults = [];
        while (++j <= 3) {
          readResults.push(src.read());
        }expect(readResults).to.deep.equal([1, 2, 3]);
        done();
      });
    });

    it('src will cause more read calls from the input', function (done) {

      // --------------------------------------------
      // this mess simulates our kafka consumer stream
      // ---------------------------------------------

      var consumer = new EventEmitter();
      var paused = true;
      var i = 0;

      function emit(consumer) {
        if (paused) return;
        consumer.emit('data', ++i);
        setTimeout(function () {
          emit(consumer);
        }, 100);
      }

      consumer.on('resume', function () {
        paused = false;
        emit(consumer);
      });

      consumer.on('pause', function () {
        paused = true;
      });

      function reader() {
        consumer.emit('resume');
      }

      var input = stream.Readable({ objectMode: true, highWaterMark: 2, read: reader });

      consumer.on('data', function (data) {
        if (!input.push(data)) {
          consumer.emit('pause');
        }
      });

      // ------------------------------------------------
      // end mess
      // ------------------------------------------------

      var created = fanout.createStreams();
      var ext = created.ext;
      var src = created.src;

      src._readableState.highWaterMark = 2;
      ext._writableState.highWaterMark = 3;

      sinon.stub(src, 'push', src.push);
      sinon.stub(ext, 'write', ext.write);
      sinon.stub(input, 'push', input.push);

      input.on('readable', _.noop); // kick off

      input.pipe(ext);

      // nothing should happen syncrhonously
      expect(src.push.callCount).to.equal(0);

      setTimeout(function () {

        // Here we see the effects of buffering that builds up
        // before the emitter is stopped.
        expect(input.push.callCount).to.equal(6);
        expect(ext.write.callCount).to.equal(4);
        expect(src.push.callCount).to.equal(2);

        // read 6 times
        var firstReads = [];
        var i = 0;
        while (++i <= 6) {
          firstReads.push(src.read());
        }expect(firstReads).to.deep.equal([1, 2, 3, 4, 5, 6]);

        // reading 6 times should have called the input.push
        // function 6 more times, and filled up all the other
        // buffers along the way.
        expect(input.push.callCount).to.equal(12);
        expect(ext.write.callCount).to.equal(10);
        expect(src.push.callCount).to.equal(8);

        done();
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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QVgsQ0FBUCxDQUE2QixFQUE3QixDQUFnQyxLQUFoQyxDQUFzQyxDQUF0QyxFQUplO0FBS2YsZUFBTyxJQUFJLEtBQUosQ0FBVSxTQUFWLENBQVAsQ0FBNEIsRUFBNUIsQ0FBK0IsS0FBL0IsQ0FBcUMsQ0FBckMsRUFMZTtBQU1mLGVBQU8sSUFBSSxJQUFKLENBQVMsU0FBVCxDQUFQLENBQTJCLEVBQTNCLENBQThCLEtBQTlCLENBQW9DLENBQXBDOzs7QUFOZSxZQVNYLGFBQWEsRUFBYixDQVRXO0FBVWYsWUFBSSxJQUFJLENBQUosQ0FWVztBQVdmLGVBQU8sRUFBRSxDQUFGLElBQU8sQ0FBUDtBQUFVLHFCQUFXLElBQVgsQ0FBZ0IsSUFBSSxJQUFKLEVBQWhCO1NBQWpCLE1BQ0EsQ0FBTyxVQUFQLEVBQW1CLEVBQW5CLENBQXNCLElBQXRCLENBQTJCLEtBQTNCLENBQWlDLENBQUMsQ0FBRCxFQUFHLENBQUgsRUFBSyxDQUFMLEVBQU8sQ0FBUCxFQUFTLENBQVQsRUFBVyxDQUFYLENBQWpDOzs7OztBQVplLGNBaUJmLENBQU8sTUFBTSxJQUFOLENBQVcsU0FBWCxDQUFQLENBQTZCLEVBQTdCLENBQWdDLEtBQWhDLENBQXNDLEVBQXRDLEVBakJlO0FBa0JmLGVBQU8sSUFBSSxLQUFKLENBQVUsU0FBVixDQUFQLENBQTRCLEVBQTVCLENBQStCLEtBQS9CLENBQXFDLEVBQXJDLEVBbEJlO0FBbUJmLGVBQU8sSUFBSSxJQUFKLENBQVMsU0FBVCxDQUFQLENBQTJCLEVBQTNCLENBQThCLEtBQTlCLENBQW9DLENBQXBDLEVBbkJlOztBQXFCZixlQXJCZTtPQUFOLENBQVgsQ0E5RDBEO0tBQVIsQ0FBcEQsQ0FoRDhCO0dBQU4sQ0FBMUIsQ0FGdUI7Q0FBTixDQUFuQiIsImZpbGUiOiJmYW5vdXQuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY2hhaS51c2UocmVxdWlyZSgnc2lub24tY2hhaScpKTtcbnZhciBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbnZhciBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xudmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjtcbnZhciBmYW5vdXQgPSByZXF1aXJlKCcuL2Zhbm91dCcpXG5cblxuZGVzY3JpYmUoJ2Zhbm91dCcsICgpID0+IHtcblxuICBkZXNjcmliZSgnY3JlYXRlU3RyZWFtcycsICgpID0+IHtcblxuICAgIGl0KCdwcm9wb2dhdGVzIGVycm9ycyB3aXRoIHRoZSBwcm9wb2dhdGUgZmxhZycsIGRvbmUgPT4ge1xuICAgICAgdmFyIGlucHV0ID0gc3RyZWFtLlJlYWRhYmxlKHsgb2JqZWN0TW9kZTogdHJ1ZSwgcmVhZDogc2lub24uc3R1YigpIH0pO1xuICAgICAgaW5wdXRcbiAgICAgICAgLnBpcGUoZmFub3V0LmNyZWF0ZVN0cmVhbXMoe3Byb3BhZ2F0ZTogdHJ1ZX0sICgpID0+IG51bGwpKVxuICAgICAgICAub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgICBleHBlY3QoZXJyKS50by5iZS5hbi5lcnJvcjtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pXG4gICAgICBpbnB1dC5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignZm9vJykpXG4gICAgfSk7XG5cbiAgICBpdCgnY3JlYXRlcyBhIGRpcmVjdCBjb25uZWN0aW9uIGJldHdlZW4gaW5wdXQgc3RyZWFtIGFuZCBzcmMgJywgZG9uZSA9PiB7XG4gICAgICB2YXIgaW5wdXQgPSBzdHJlYW0uUmVhZGFibGUoeyBvYmplY3RNb2RlOiB0cnVlLCBoaWdoV2F0ZXJNYXJrOiAyLCByZWFkOiBzaW5vbi5zdHViKCkgfSk7XG4gICAgICB2YXIgY3JlYXRlZCA9IGZhbm91dC5jcmVhdGVTdHJlYW1zKCk7XG4gICAgICB2YXIgZXh0ID0gY3JlYXRlZC5leHQ7XG4gICAgICB2YXIgc3JjID0gY3JlYXRlZC5zcmM7XG5cbiAgICAgIHNpbm9uLnN0dWIoc3JjLCAncHVzaCcsIHNyYy5wdXNoKTtcbiAgICAgIHNpbm9uLnN0dWIoZXh0LCAnd3JpdGUnLCBleHQud3JpdGUpO1xuXG4gICAgICBpbnB1dC5waXBlKGV4dCk7XG5cbiAgICAgIHZhciBpID0gMDtcbiAgICAgIHZhciBwdXNoUmVzdWx0cyA9IFtdXG4gICAgICB3aGlsZSAoKytpIDw9IDMpIHB1c2hSZXN1bHRzLnB1c2goaW5wdXQucHVzaChpKSk7XG5cbiAgICAgIGV4cGVjdChwdXNoUmVzdWx0cykudG8uZGVlcC5lcXVhbChbdHJ1ZSwgZmFsc2UsIGZhbHNlXSk7XG4gICAgICBleHBlY3Qoc3JjLnB1c2guY2FsbENvdW50KS50by5lcXVhbCgwKTtcbiAgICAgIGV4cGVjdChleHQud3JpdGUuY2FsbENvdW50KS50by5lcXVhbCgwKTtcbiAgICAgIGV4cGVjdChpbnB1dC5fcmVhZC5jYWxsQ291bnQpLnRvLmVxdWFsKDApXG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAgIC8vIE5vdGU6IHRoaXMgc2hvd3MgdGhhdCB0aGVzZSBhcmUgYWxsIGFzeW5jcmhvbm91czpcbiAgICAgICAgZXhwZWN0KHNyYy5wdXNoLmNhbGxDb3VudCkudG8uZXF1YWwoMyk7XG4gICAgICAgIGV4cGVjdChleHQud3JpdGUuY2FsbENvdW50KS50by5lcXVhbCgzKTtcbiAgICAgICAgZXhwZWN0KGlucHV0Ll9yZWFkLmNhbGxDb3VudCkudG8uZXF1YWwoMSlcbiAgICAgICAgdmFyIGogPSAwO1xuICAgICAgICB2YXIgcmVhZFJlc3VsdHMgPSBbXTtcbiAgICAgICAgd2hpbGUoKytqIDw9IDMpIHJlYWRSZXN1bHRzLnB1c2goc3JjLnJlYWQoKSk7XG5cbiAgICAgICAgZXhwZWN0KHJlYWRSZXN1bHRzKS50by5kZWVwLmVxdWFsKFsxLDIsM10pO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KVxuICAgIH0pO1xuXG4gICAgaXQoJ3NyYyB3aWxsIGNhdXNlIG1vcmUgcmVhZCBjYWxscyBmcm9tIHRoZSBpbnB1dCcsIGRvbmUgPT4ge1xuXG4gICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgLy8gdGhpcyBtZXNzIHNpbXVsYXRlcyBvdXIga2Fma2EgY29uc3VtZXIgc3RyZWFtXG4gICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgICAgdmFyIGNvbnN1bWVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgdmFyIHBhdXNlZCA9IHRydWU7XG4gICAgICB2YXIgaSA9IDA7XG5cbiAgICAgIGZ1bmN0aW9uIGVtaXQgKGNvbnN1bWVyKSB7XG4gICAgICAgIGlmIChwYXVzZWQpIHJldHVybjtcbiAgICAgICAgY29uc3VtZXIuZW1pdCgnZGF0YScsICsraSk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGVtaXQoY29uc3VtZXIpXG4gICAgICAgIH0sIDEwMClcbiAgICAgIH1cblxuICAgICAgY29uc3VtZXIub24oJ3Jlc3VtZScsICgpID0+IHtcbiAgICAgICAgcGF1c2VkID0gZmFsc2U7XG4gICAgICAgIGVtaXQoY29uc3VtZXIpO1xuICAgICAgfSlcblxuICAgICAgY29uc3VtZXIub24oJ3BhdXNlJywgKCkgPT4ge1xuICAgICAgICBwYXVzZWQgPSB0cnVlO1xuICAgICAgfSlcblxuICAgICAgZnVuY3Rpb24gcmVhZGVyICgpIHtcbiAgICAgICAgY29uc3VtZXIuZW1pdCgncmVzdW1lJyk7XG4gICAgICB9XG5cbiAgICAgIHZhciBpbnB1dCA9IHN0cmVhbS5SZWFkYWJsZSh7IG9iamVjdE1vZGU6IHRydWUsIGhpZ2hXYXRlck1hcms6IDIsIHJlYWQ6IHJlYWRlciB9KTtcblxuICAgICAgY29uc3VtZXIub24oJ2RhdGEnLCBkYXRhID0+IHtcbiAgICAgICAgaWYgKCFpbnB1dC5wdXNoKGRhdGEpKSB7XG4gICAgICAgICAgY29uc3VtZXIuZW1pdCgncGF1c2UnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgLy8gZW5kIG1lc3NcbiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgICB2YXIgY3JlYXRlZCA9IGZhbm91dC5jcmVhdGVTdHJlYW1zKCk7XG4gICAgICB2YXIgZXh0ID0gY3JlYXRlZC5leHQ7XG4gICAgICB2YXIgc3JjID0gY3JlYXRlZC5zcmM7XG5cbiAgICAgIHNyYy5fcmVhZGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrID0gMjtcbiAgICAgIGV4dC5fd3JpdGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrID0gMztcblxuICAgICAgc2lub24uc3R1YihzcmMsICdwdXNoJywgc3JjLnB1c2gpO1xuICAgICAgc2lub24uc3R1YihleHQsICd3cml0ZScsIGV4dC53cml0ZSk7XG4gICAgICBzaW5vbi5zdHViKGlucHV0LCAncHVzaCcsIGlucHV0LnB1c2gpO1xuXG4gICAgICBpbnB1dC5vbigncmVhZGFibGUnLCBfLm5vb3ApOyAvLyBraWNrIG9mZlxuXG4gICAgICBpbnB1dFxuICAgICAgICAucGlwZShleHQpO1xuXG4gICAgICAvLyBub3RoaW5nIHNob3VsZCBoYXBwZW4gc3luY3Job25vdXNseVxuICAgICAgZXhwZWN0KHNyYy5wdXNoLmNhbGxDb3VudCkudG8uZXF1YWwoMCk7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAgIC8vIEhlcmUgd2Ugc2VlIHRoZSBlZmZlY3RzIG9mIGJ1ZmZlcmluZyB0aGF0IGJ1aWxkcyB1cFxuICAgICAgICAvLyBiZWZvcmUgdGhlIGVtaXR0ZXIgaXMgc3RvcHBlZC5cbiAgICAgICAgZXhwZWN0KGlucHV0LnB1c2guY2FsbENvdW50KS50by5lcXVhbCg2KTtcbiAgICAgICAgZXhwZWN0KGV4dC53cml0ZS5jYWxsQ291bnQpLnRvLmVxdWFsKDQpO1xuICAgICAgICBleHBlY3Qoc3JjLnB1c2guY2FsbENvdW50KS50by5lcXVhbCgyKTtcblxuICAgICAgICAvLyByZWFkIDYgdGltZXNcbiAgICAgICAgdmFyIGZpcnN0UmVhZHMgPSBbXTtcbiAgICAgICAgdmFyIGkgPSAwO1xuICAgICAgICB3aGlsZSAoKytpIDw9IDYpIGZpcnN0UmVhZHMucHVzaChzcmMucmVhZCgpKTtcbiAgICAgICAgZXhwZWN0KGZpcnN0UmVhZHMpLnRvLmRlZXAuZXF1YWwoWzEsMiwzLDQsNSw2XSk7XG5cbiAgICAgICAgLy8gcmVhZGluZyA2IHRpbWVzIHNob3VsZCBoYXZlIGNhbGxlZCB0aGUgaW5wdXQucHVzaFxuICAgICAgICAvLyBmdW5jdGlvbiA2IG1vcmUgdGltZXMsIGFuZCBmaWxsZWQgdXAgYWxsIHRoZSBvdGhlclxuICAgICAgICAvLyBidWZmZXJzIGFsb25nIHRoZSB3YXkuXG4gICAgICAgIGV4cGVjdChpbnB1dC5wdXNoLmNhbGxDb3VudCkudG8uZXF1YWwoMTIpO1xuICAgICAgICBleHBlY3QoZXh0LndyaXRlLmNhbGxDb3VudCkudG8uZXF1YWwoMTApO1xuICAgICAgICBleHBlY3Qoc3JjLnB1c2guY2FsbENvdW50KS50by5lcXVhbCg4KTtcblxuICAgICAgICBkb25lKCk7XG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG59KTtcbiJdfQ==